---
title: ロボットの落下から立ち直る—設計改善の記録
author: masayuki-kono
tags: [ロボット開発, 太陽光発電, 清掃ロボット]
date: 2025-xx-xx
image: true
---

豆蔵では太陽光発電パネルの自動清掃ロボットの開発に取り組んでいます。
本記事では、開発過程で直面したロボットの落下問題とその対策について、具体的な改善事例を紹介します。

## プロジェクトの概要

太陽光パネルの発電効率を最大限に保つためには、表面に堆積する埃や汚れの定期的な除去が不可欠です。
一般家庭用の小規模なパネルであれば手作業での清掃も可能ですが、
メガソーラーなどの大規模な発電施設では、人力による清掃作業は効率面・コスト面で現実的ではありません。

![メガソーラー発電所のイメージ](/img/robotics/clean-robot/solar-panel.png)

当社では、このような発電施設向けの自律型清掃ロボットを開発しています。
開発チームは、プロジェクトリーダー、機械設計、電気設計、ソフトウェア開発（筆者）計4名で構成されています。

![開発中の清掃ロボット](/img/robotics/clean-robot/clean-robot-proto-2nd.png)

## 清掃ロボットのシステム構成

清掃ロボットにはPico-ITX仕様の小型のSBCが搭載されており、このSBC上でロボットを制御するアプリケーション（図中の`CleanRobotController`）が動作します。SBC周辺のシステム構成を以下に示します。

![システム構成](/img/robotics/clean-robot/system-structure-related-to-sbc-proto-2nd.png)

太陽光パネルは地表から2m以上の高い位置に設置されており、ロボットには清掃だけではなく「決して落ちない」信頼性も求められます。パネルからの落下を回避するために、ロボットの前後には複数の超音波距離センサが配置されています。それ以外にも左右のクローラを駆動するサーボや姿勢を推定するためのIMU、パネルのラインを検出して追従するためのカメラなど、様々なデバイスが搭載されています。

SBCには制御アプリケーション以外にWebサーバーも動作し、遠隔操作用のWebUI（図中の`RemoteOperationUI`）を提供します。太陽光パネルから離れた場所でこのWebUIを操作することで、自律清掃の開始や停止、手動操作が行えます。

## アプリケーション構成

制御アプリケーションは複数のROS2ノードで構成され、これらのノードが[ROS2の通信](https://docs.ros.org/en/humble/How-To-Guides/Topics-Services-Actions.html)（トピック、サービス、アクション）を介して連携し、各機能を実現します。

以下の図は主要ノードの構成イメージです。各種ハードウェアとの通信ドライバのほか、`robot_navigator`というノードが自律走行などの制御を統括します。UIは`rosbridge_websocket`ノードを中継して [roslibjs](https://github.com/RobotWebTools/roslibjs)でROS2側と通信するWebアプリケーションであり、ROS2には直接は依存していません。

実際には他にも多くのトピックやノードが存在し、またノード間の通信は多対多の形で行われます。

![ノード構成](/img/robotics/clean-robot/node-structure-proto-2nd.png)

## 落下した

1次試作機の完成後、フィールドテスト中のことでした。
一通りの検証を終え、最後にビジネスパートナーと開発メンバーで走行映像を撮影していました。

パネルの端を超音波距離センサで検出して旋回するはずが、なぜか全力疾走。
「止まれー!」と叫ぶ声もむなしく、無情にも地表へダイブしてしまいました。

![落下した](/img/robotics/clean-robot/falling-down.gif)

※最後に駆け寄っているのは筆者です。残念ながらキャッチには間に合いませんでした。

## 解析

既に筆者のハートは粉々でしたが、現象発生から30分後の作戦会議に向けて急ピッチで解析しました。
（他の開発メンバは予備パーツへの換装や折れ曲がった板金の手加工で復旧作業）

当時のログ解析結果の一部を抜粋します。分かりづらいですが生々しさを出すため敢えてそのままです。

```shell
超音波距離センサ（前方）でエッジ検出
[INFO] 1727160076.597380616 [safety_control] changed safety_status(can_move_forward:0,can_move_backward:1)

超音波距離センサ（後方）でエッジ検出
⇒この時点で既に車体全体がパネル外へ（落下開始）
[INFO] 1727160077.474055997 [safety_control] changed safety_status(can_move_forward:0,can_move_backward:0)

減速停止開始（エッジを検出してから既に1.2秒経過★）
[INFO] 1727160077.772765824 [rs485_motor_control] immediate stopping at current position left:0.0,right:132.2

減速停止完了
[INFO] 1727160078.029448388 [rs485_motor_control] keep current position at left:-146.2,right:134.9

落下の衝撃でリアカメラと通信不可状態へ
[ERROR] 1727160078.180602455 [rear_camera] Error dequeueing buffer: No such device (19)
```

超音波距離センサ（前方）でパネルの端を検出したにもかかわらず、`rs485_motor_control`ノードでサーボへ減速停止を指示するまでに1.2秒も遅延したことが分かりました。

![rs485_motor_controlノード](/img/robotics/clean-robot/rs-485-motor-control.png)

現地での作戦会議の時点では原因まではつかめませんでしたが、帰国後の再現試験で原因を特定出来ました。

左右のクローラを制御するサーボと100msec周期で通信し、速度指令の送信や状態を取得しています。

各処理のパフォーマンスをプロファイリングしたところ、**1分に1回**くらいの頻度でサーボとの通信で応答がなくタイムアウトしていることが分かりました。
タイムアウト時間は1秒としており、その間は次の速度指令をサーボへ送信できず、サーボ側は前回の速度指令を維持したまま走行してしまうことも分かりました。
この**1分に1回**というタイミングでパネルの端に到達するとタイムアウト時間だけ停止距離が長くなり、パネルから落下するという問題でした。

## 対策

サーボの再選定という方向性もありましたが、2次試作までには間に合わないため、それ以外で対応可能な範囲での対策に留めました。

* 正常時におけるサーボとの通信時間を計測し、タイムアウト時間を最適化（短縮）
    * 50msec＋マージン
    * 赤枠のサンプルがタイムアウト発生時の処理時間
    ![ブラシ先端に超音波距離センサを増設](/img/robotics/clean-robot/servo-com-processing-time.png)
* ブラシ先端に超音波距離センサを増設し、より早いタイミングで端への到達を検出（予測）
    * 増設したセンサで端を検出したら走行速度を低速とし、一定量走行した後に停止して旋回（パネルの隅まで清掃したいという要望があるため、ブラシがパネル外に出るまで走行する必要があります）
* 類似としてパネルの端付近で並走中に片側のクローラーが脱輪する可能性もあったため、車体の左右のサイド側にもセンサを増設し、サイドエッジ検出時の回避動作を実装しました
    ![ブラシ先端に超音波距離センサを増設](/img/robotics/clean-robot/clean-robot-proto-2nd-add-edge-sensors.png)

## リベンジ

前述した対策や各種機能追加を追え、先日2次試作機を発電所へ持ち込んでデモに臨みました。

機能的な課題は多々発生したものの、パネルからは落下せず。無事デモを終えることができました。

それ以降、ロボットがパネルから落下するという悪夢にうなされることは、ほとんどなくなりました（トラウマ）。

## 最後に

清掃ロボットの開発はまだまだ続きます。
次は「落ちない」だけでなく、「効率よく清掃する」という本来の目的に向けて邁進します。
もちろん、その過程で新たな「事件」が起きるかもしれませんが...それはまた別の記事でご紹介させていただきます。
