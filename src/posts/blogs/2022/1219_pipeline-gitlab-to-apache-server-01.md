---
title: AWS上に継続的デリバリ環境を構築する 第１回：VPC作成～Apacheインストール
 author: ryosuke-kono
 # 公開日として設定されますので、それを考慮した日付にするようにしてください
 date: 2022-12-19
 # 以下のタグは任意です。つけるものあれば追加してください。まず既存タグ(トップページにあります)に使えるものがあるかを確認してください。なければ新規に作成してもらって大丈夫です
 tags: [mamezou]
 ---
[[TOC]]

 ## はじめに
 本稿ではAWSのサービスやGitLabなどを使用し、簡単な継続的デリバリ環境を構築する手順を解説します。
 継続的デリバリ環境を構築することで、開発したプログラムを利用環境へリリースする作業を自動化できます。本稿ではAWSのサービスを主に使用し、継続的デリバリ環境の構築を行います。
 作成する環境の構成図は以下の図の通りです。

![パイプライン構成図](https://gyazo.com/1dfaf7eb056de8dcc27dd7f41367befc.png)

 まず、開発者がGitLabにpushしたソースをCodeCommitへミラーリングします。その変更がCodePipelineに検知されると、CodeDeployがCodeCommitからソースを取得し、Apacheサーバーへデプロイするといった構成となっています。
 第１回では、

 * 仮想ネットワークであるVPCの作成

 * Apache用サーバーに使用するEC2インスタンスの作成

 * 作成したEC2にSSH接続しApacheインストール

の３つの手順を解説していきます。

## １．VPC作成

 AWSのマネジメントコンソールからVPCのコンソールを開き、「VPCを作成」を押下します。今回の構築では、東京リージョンに環境を作るので、リージョンはアジアパシフィック（東京）を選択してください。ここで選択するVPCの設定は以下の画像の通りです。

![vpc設定1](https://gyazo.com/7754c134ed10b2c545ffb256faabca50.png)
![vpc設定2](https://gyazo.com/e30d8e9925623c874e6807557265b06e.png)

 今回はシンプルな構成にするため、プライベートサブネットは0としています。また、今回の構築には必要がないため、NATゲートウェイ、VPCエンドポイントはなしとしています。設定した構成は、右のプレビューに図として表示されているため、問題がないことを確認できたら「VPCを作成」を押下します。VPCのコンソールから、作成したVPCの状態がAvailableとなっていれば作成は完了です。

## ２．Apache用EC2作成

 次に、デプロイ先となるApache用のEC2を作成します。AWSのマネジメントコンソールからEC2を選択し、「インスタンスを起動を押下」します。ここで選択する設定は以下の通りです。

![ec2設定1](https://gyazo.com/14f1fedca59d1f0b197f0a7100bb7ee4.png)

 アプリケーションおよび OS イメージ (Amazon マシンイメージ)は、RedHatを使用します。Apache用サーバーに性能は必要ないので、無料使用枠対象の方は無料利用枠のもので構いません。インスタンスタイプもt2.microを選択してください。
 これらの設定の中で重要なものが２つあります。１つ目はキーペアです。「新しいキーペアの作成」を押下し、任意のキーペア名を入力します。キーペアのタイプとプライベートキーファイル形式はデフォルトのもので大丈夫です。必要項目を入力したら、「キーペアを作成」を押下します。プライベートキーファイルがダウンロードされるので、必ず保管し削除しないようにしてください。この後の作業で必要になります。

![キーペア設定](https://gyazo.com/4199e41639819de1ef807efa6d6f1d9f.png)

 ２つ目は、Network settingsです。VPCにデフォルトVPCが選択されているため、プルダウンから先ほど作成したVPCを選択してください。パブリック IP の自動割り当ても、デフォルトでは無効化になっているので有効化を選択してください。

![ec2設定2](https://gyazo.com/96cd818b557b228c52a04d9a82af0f3d.png)

 また、HTTP接続用にセキュリティグループルールから80番ポートも開けておきましょう。

![ec2設定3](https://gyazo.com/fc59a82d130626c992acab13b5bf1708.png)

 ストレージは、10GB→30GBに変更した方が動作が安定すると思います。他にも設定項目はありますが、基本的にはデフォルトのままで大丈夫です。設定が終わり、確認ができたら「インスタンスを起動」を押下してください。画面に「成功」と表示されたら、Apache用EC2作成は完了です。この後の作業で必要になるので、EC2コンソールからインスタンスを確認し、パブリック IPv4 DNSを控えておいてください。

## ３．Apacheインストール

 次に、作成したApache用EC2にSSH接続し、Apacheインストールを行います。
 まず、GitBashからApache用EC2にSSH接続します。今回の構築用にフォルダを作成し、先ほどダウンロードしたプライベートキーファイルを配置します。GitBashで該当ディレクトリに移動し、以下のコードを使ってSSH接続します。

  ` ssh -i 公開鍵 ec2-user@IPアドレス`

![Apacheインストール1](https://gyazo.com/cfd7fc6d9483bf8c555289b350fb517e.png)

 公開鍵は.pemファイル、IPアドレスは先ほど控えたパブリック IPv4 DNSを使用します。RedHatではデフォルトユーザーがec2-userとなっています。接続確認でyesを入力し、上の画像の状態になればSSH接続完了です。
 次に、以下のコマンドを使用してパッケージをアップデートしておきます。Complete!と表示されれば完了です。

  `sudo yum update -y`

 いよいよApacheのインストールです。以下のコマンドを使用してインストールを行います。こちらもComplete!と表示されれば完了です。

  `sudo yum install -y httpd`

 Apacheを以下のコマンドで起動します。エラーが発生しなければ、問題なく起動しています。
  sudo systemctl start httpd'
 Apacheが起動しているかの確認を行います。以下のコマンドを入力してください。Activeと表示されていれば大丈夫です。

  `sudo systemctl status httpd`

![Apacheインストール2](https://gyazo.com/63b74aa4d75902ee7edb8d7450c8ac6c.png)

 Apacheの自動起動の設定を行います。以下のコマンドを実行してください。

  `sudo systemctl enable httpd`

 Apacheの自動起動設定が有効か確認をします。以下のコマンドを実行してください。httpd.serviceがenableになっていることを確認できれば大丈夫です。

  `sudo systemctl list-unit-files -t service | grep httpd`

![Apacheインストール3](https://gyazo.com/dfd3479814a76dccdb6011c7bb81ac1f.png)


## さいごに

 今回は、VPCを作成し、その中に配布先であるApacheをインストールしたEC2を準備しました。
 次回はpush先のGitLab用のEC2作成、docker-composeを使用したGitLab導入について解説します。
