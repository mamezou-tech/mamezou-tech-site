---
title: 文字コード これだけは覚えておこう ～Unicode～
author: yoshifumi-moriya
date: 2025-09-06
tags: [java,  文字コード]
---

## はじめに

今回は新人さんに向けての記事ということで、我々日本語を扱うプログラマーが長年捕らわれ続けている問題である「文字コード」の問題について語りたいと思います。

「文字コード」には非常に長い歴史があり、当時の技術者たちが直面した制約の中で生まれた、苦悩や試行錯誤の積み重ねの産物です。そのため、現在の姿だけを見て「いまいち」「分かりにくい」と単純に批評することはできません。しかしながら、私たちはこの問題を避けて通ることはできません。そこで、本稿では文字コードの性質と、陥りやすい事象について、ケースごとに対処方法を示します。

[前回](/blogs/2024/06/16/moji-code1/)のシフトJISに続き、今回は文字コード「Unicode」の「UTF-8」について、これだけは知っておいてほしいポイントを解説します。

## 今回言いたいポイント

* もうシフトJISとかやめてUnicodeに統一しちゃいたいよね
* Unicodeを使う上での注意すべきポイント
  * UTF-8におけるBOMについて

## Unicodeってなんですか

Unicodeは、今や世界標準と言ってよいほど広く浸透しており、Javaの内部でも使用されているため、避けては通れない文字コードとなっています。
正確には、Unicodeとは「文字集合」であり、世界中のあらゆる文字（英数字、記号、ひらがな、カタカナ、漢字など）を扱うことを目的としています。各文字には「コードポイント」と呼ばれる一意の番号が割り当てられており、たとえば「A」（半角のA）は `U+0041`、「あ」は `U+3042` というコードポイントが付けられています。
Unicodeですべての文字を扱えるのであれば、シフトJISなどを使う必要はなく、すべてUnicodeに統一すれば文字コードの問題は解決しそうにも思えますね。

しかし、実際にはUnicodeを使えばすべてが解決するというわけではありません。
今回は、Unicodeのエンコーディング方式のひとつである「UTF-8」で発生しうる問題点について解説します。

## UTF-8ってなんですか

具体的な問題点を解説する前に、Unicodeのエンコーディング方式である「UTF-8」について簡単に触れてみます。

UTF-8というエンコーディング方式は、Unicodeのコードポイント（`U+0000`〜`U+10FFFF`）を、1〜4バイトの可変長で表現します。
たとえば、「A」（U+0041）や「あ」（U+3042）は、次のようにUTF-8で表されます。

* 「A」(`U+0041`) : `0x41` (1バイト)
* 「あ」(`U+3042`) : `0xE3 0x81 0x82` (1バイト)

UTF-8では、コードポイントの値に応じて必要なバイト数が変わります。

* 1バイト：U+0000 ～ U+007F（ASCII）
* 2バイト：U+0080 ～ U+07FF
* 3バイト：U+0800 ～ U+FFFF（ほとんどの日本語の文字はここに含まれる）
* 4バイト：U+10000 ～ U+10FFFF（補助面の文字）

そのため、文字によってUTF-8のバイト列の長さが異なるのが特徴です。

## BOMってなんですか

今回の「問題点」を解説する前に「BOM」にも触れておきます。
BOM（Byte Order Mark）は、テキストの先頭に付けられるバイト順（エンディアン）を示す目印です。
UTF-16やUTF-32といったエンコーディング方式では、どの順序でバイトを並べるかを指定する必要があります。このバイトの順序のことを「エンディアン」と呼びます。
たとえば、文字「A」（U+0041）はUTF-16では以下のように表されます。

* ビッグエンディアン（BE）：`0x00 0x41`（上位バイトを先に書く）
* リトルエンディアン（LE）：`0x41 0x00`（下位バイトを先に書く）

## UTF-8におけるBOM

UTF-8はエンディアンに依存しないエンコーディング方式であるため、通常はBOMを付与する必要はありません。ただし、ファイルがUTF-8であることを明示する目的で、あえてBOMを付けることもあります。
身近な例としては、ExcelでCSVファイルをUTF-8形式で出力する際、BOMが自動的に付与されます。これが原因で、さまざまな場面で問題が生じることがあります。

例えば、JSPファイルやThymeleafのテンプレートはHTMLレスポンスを生成しますが、UTF-8のBOM付きで記述されていると、HTMLの先頭にあるべき `<!DOCTYPE html>` の前に `0xEF 0xBB 0xBF` が出力されてしまいます。ブラウザによっては、これによりHTMLとして正しく解釈されないことがあります。

また、CSVファイルの読み込み時も注意が必要です。BOMの存在を想定していないコードでは、先頭の数バイトがゴミとして扱われたり、ヘッダ名が正しく読み取れずにエラーになる場合があります。

## この問題の厄介な点

この問題の厄介な点は、BOMがエディタ上では目に見えないことです。
エラーが発生したJSPファイルやCSVファイルを確認しても、ファイルの先頭にBOMが含まれていることには気づきにくく、原因の特定が遅れてしまうことがあります。

TODO:
解決のためには、
バイナリエディタつかう
ユーザーが作成する場合にはBOMを読み飛ばす処理をいれることも検討する

## まとめ
