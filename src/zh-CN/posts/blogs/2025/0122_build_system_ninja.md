---
title: ä½¿ç”¨ Ninja åŠ é€Ÿæ„å»ºï¼è¯¦è§£å…¶ä½¿ç”¨æ–¹æ³•
author: kotaro-miura
date: 2025-01-22T00:00:00.000Z
tags:
  - Ninja
  - Make
  - graphviz
image: true
translate: true

---

# å‰è¨€

æœ€è¿‘æˆ‘åœ¨ä½¿ç”¨æ„å»ºå·¥å…· Makeï¼Œå¿ƒæƒ³â€œè¿™ä¸ªå·¥å…·è™½ç„¶ç”¨äº†å¾ˆä¹…ï¼Œä½†æœ‰æ²¡æœ‰ä»€ä¹ˆæ–°çš„æ„å»ºå·¥å…·å¹¿æ³›æµè¡Œå‘¢ï¼Ÿâ€æŸ¥æ‰¾ä¹‹åå¾—çŸ¥ [Ninja](https://github.com/ninja-build/ninja) è¿™ä¸ªå·¥å…·éå¸¸ä¸é”™ï¼Œäºæ˜¯å†³å®šå°è¯•ä¸€ä¸‹ï¼Œå¹¶å°†ä½“éªŒè¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ã€‚

# Ninja çš„ç‰¹ç‚¹

Ninja æ˜¯ä¸€æ¬¾ä»¥æ¯” Make æ›´é«˜é€Ÿè¿è¡Œä¸ºå–ç‚¹çš„æ„å»ºç³»ç»Ÿã€‚

å®ƒæœ€åˆä¸ºäº†åŠ å¿«åƒ Google Chrome è¿™æ ·çš„å¤§å‹é¡¹ç›®ï¼ˆä»å¤§çº¦ 40,000 ä¸ª C++ æ–‡ä»¶ç¼–è¯‘ç”Ÿæˆå•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼‰çš„æ„å»ºé€Ÿåº¦è€Œå¼€å‘ã€‚[^ninja-his]

[^ninja-his]:[Evan Martin. The Performance of Open Source Software Ninja](https://aosabook.org/en/posa/ninja.html)

å®ƒæå‡ºäº†å¦‚ä¸‹è®¾è®¡ç›®æ ‡ã€‚[^design-goal]

> - å³ä½¿åœ¨åºå¤§é¡¹ç›®ä¸­ä¹Ÿèƒ½è¿›è¡Œéå¸¸å¿«é€Ÿçš„å¢é‡æ„å»º
> - å‡ ä¹ä¸å¯¹ä»£ç çš„æ„å»ºæ–¹å¼æ–½åŠ ä»»ä½•ç­–ç•¥é™åˆ¶
> - å³ä¾¿åœ¨ Makefile éš¾ä»¥æ­£ç¡®è§£æçš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½å‡†ç¡®æŒæ¡ä¾èµ–å…³ç³»
> - å½“ä¾¿åˆ©æ€§ä¸é€Ÿåº¦å‘ç”Ÿå†²çªæ—¶ï¼Œä»¥é€Ÿåº¦ä¸ºä¼˜å…ˆ

åè¿‡æ¥ï¼Œä¸‹åˆ—äº‹é¡¹åˆ™å¹¶éå…¶æ˜ç¡®çš„è®¾è®¡ç›®æ ‡ï¼š

> - ç”¨äºæ‰‹å·¥ç¼–å†™æ„å»ºæ–‡ä»¶çš„ä¾¿æ·è¯­æ³•  
>     - Ninja æ–‡ä»¶åº”é€šè¿‡å…¶ä»–ç¨‹åºç”Ÿæˆã€‚ï¼ˆæ”¯æŒ CMakeã€Meson ç­‰ï¼ˆä½œè€…è¡¥å……ï¼‰ï¼‰
> - å†…ç½®è§„åˆ™  
>     - Ninja ä¸å…·å¤‡ç±»ä¼¼ Make é‚£ç§ç”¨äºç¼–è¯‘ C ä»£ç çš„éšå¼è§„åˆ™ã€‚
> - æ„å»ºæ—¶çš„å®šåˆ¶  
>     - å‘½ä»¤é€‰é¡¹åº”åŒ…å«åœ¨ç”Ÿæˆ Ninja æ–‡ä»¶çš„ç¨‹åºä¸­ã€‚
> - æ„å»ºæ—¶çš„æ¡ä»¶åˆ†æ”¯åŠæœç´¢è·¯å¾„  
>   - ç”±äºå†³ç­–è¿‡ç¨‹è¾ƒæ…¢ï¼Œåº”å°½é‡é¿å…ã€‚

[^design-goal]:[Design goals](https://ninja-build.org/manual.html#_design_goals)

GitHub Star æ•°ä¹Ÿåœ¨ä¸æ–­å¢é•¿ï¼Œçœ‹èµ·æ¥æ­£åœ¨é¡ºåˆ©æ™®åŠã€‚
[Star History Chart](https://star-history.com/#ninja-build/ninja&Date)

å¯ä»¥ä» [æ‰‹å†Œ](https://ninja-build.org/manual.html) ä¸­æŸ¥çœ‹è¯¦ç»†çš„è§„æ ¼è¯´æ˜ã€‚

# è¯•ç”¨

åœ¨ Ubuntu ç¯å¢ƒä¸‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š

```sh
$ sudo apt-get install ninja-build
```

# ninja å‘½ä»¤

ä½¿ç”¨ `ninja` å‘½ä»¤æ¥æ‰§è¡Œæ„å»ºã€‚

æŒ‰å¦‚ä¸‹æ ¼å¼æ‰§è¡Œï¼š

```sh
ninja [ã‚ªãƒ—ã‚·ãƒ§ãƒ³] [ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå...]
```

# é…ç½®æ–‡ä»¶(`build.ninja`)

æ‰§è¡Œ ninja æ—¶ï¼Œé»˜è®¤ä¼šä»å½“å‰ç›®å½•ä¸‹çš„ `build.ninja` æ–‡ä»¶è¯»å–é…ç½®ã€‚

å¦‚æœè¦æŒ‡å®šæ–‡ä»¶åæ¥æ‰§è¡Œï¼Œåˆ™ä½¿ç”¨ `ninja -f æ–‡ä»¶è·¯å¾„` é€‰é¡¹ã€‚

é‚£ä¹ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹é…ç½®æ–‡ä»¶çš„ä¹¦å†™æ–¹æ³•ã€‚

åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š

```sh:build.ninja
rule ãƒ«ãƒ¼ãƒ«å
    command = ã‚³ãƒãƒ³ãƒ‰

build ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ãƒ«ãƒ¼ãƒ«å ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«
```

åŸºæœ¬ä¸Šï¼Œæ˜¯é€šè¿‡ä½¿ç”¨ `rule` å’Œ `build` ä¸¤ç§å£°æ˜è¯­å¥æ¥æè¿°ã€‚

- åœ¨ build è¯­å¥ä¸­ï¼Œå°†ç›®æ ‡ï¼ˆå³è¦ç”Ÿæˆçš„æ–‡ä»¶åï¼‰ä¸å¯¹åº”çš„è§„åˆ™ï¼ˆç”Ÿæˆæ–¹æ³•ï¼‰åŠä¾èµ–æ–‡ä»¶ï¼ˆç”Ÿæˆæ‰€éœ€çš„æ–‡ä»¶ï¼‰è¿›è¡Œå…³è”ã€‚ç›®æ ‡å’Œä¾èµ–æ–‡ä»¶å‡å¯ç”¨ç©ºæ ¼åˆ†éš”æŒ‡å®šå¤šä¸ªæ–‡ä»¶åã€‚
- åœ¨ rule è¯­å¥ä¸­ï¼Œåœ¨ `command =` åè·Ÿä¸Šä¸ºäº†ç”Ÿæˆæ–‡ä»¶è€Œéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚

## ç¤ºä¾‹

ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚

```sh:build.ninja
rule r1
    command = echo "DEP sample" > $out

rule r2
    command = echo "TEST `cat $in`" > $out

build test.txt: r2 dep.txt
build dep.txt: r1
```

### ç¤ºä¾‹è§£æ

1. 
    ```sh
    build test.txt: r2 dep.txt
    ```
    è¡¨ç¤ºç”¨è§„åˆ™ `r2`ï¼Œé€šè¿‡ä¾èµ–æ–‡ä»¶ `dep.txt` æ¥ç”Ÿæˆ `test.txt` æ–‡ä»¶ã€‚  
    å¦‚æœ `dep.txt` ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ‰§è¡Œç”Ÿæˆ `dep.txt` çš„ build è¯­å¥ã€‚
2. 
    ```sh
    build dep.txt: r1
    ```
    è¡¨ç¤ºç”¨è§„åˆ™ `r1` ç”Ÿæˆ `dep.txt` æ–‡ä»¶ã€‚æ²¡æœ‰æŒ‡å®šä¾èµ–æ–‡ä»¶ã€‚
3. 
    ```sh
    rule r1
        command = echo "DEP sample" > $out
    ```
    åœ¨è§„åˆ™ `r1` ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤ç”ŸæˆåŒ…å«æ–‡æœ¬ `DEP sample` çš„æ–‡ä»¶ã€‚  
    æ­¤å¤„çš„ `$out` æ˜¯ Ninja å†…ç½®å˜é‡ï¼Œä¼šå±•å¼€ä¸ºåœ¨ build è¯­å¥ä¸­æŒ‡å®šçš„**ç›®æ ‡æ–‡ä»¶å**ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º `dep.txt`ã€‚
4. 
    ```sh
    rule r2
        command = echo "TEST `cat $in`" > $out
    ```
    åœ¨è§„åˆ™ `r2` ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤ç”Ÿæˆä¸€ä¸ªåœ¨è¾“å…¥æ–‡ä»¶å†…å®¹å‰è¿½åŠ  `TEST` å­—ç¬¦ä¸²çš„æ–‡ä»¶ã€‚  
    è¿™é‡Œçš„ `$in` åŒæ ·ä¸º Ninja å†…ç½®å˜é‡ï¼Œä¼šå±•å¼€ä¸ºåœ¨ build è¯­å¥ä¸­æŒ‡å®šçš„**ä¾èµ–æ–‡ä»¶å**ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º `dep.txt`ã€‚

### ç¤ºä¾‹è¿è¡Œç»“æœ

æ¥ä¸‹æ¥ï¼Œç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶æ‰§è¡Œæ„å»ºã€‚ä¸ Make ç±»ä¼¼ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ï¼Œæ ¹æ®ä¾èµ–æ–‡ä»¶æ˜¯å¦å‘ç”Ÿæ›´æ”¹ï¼Œä¼šè‡ªåŠ¨è·³è¿‡ç›®æ ‡ç”Ÿæˆã€‚

```sh
$ ninja test.txt
[2/2] echo "TEST `cat dep.txt`" > test.txt

# æ–‡ä»¶å†…å®¹ç¡®è®¤
$ cat dep.txt test.txt
DEP sample
TEST DEP sample

# å³ä½¿å†æ¬¡æ‰§è¡Œæ„å»ºï¼Œä¹Ÿä¸ä¼šè¿›è¡Œæ›´æ–°ã€‚
$ ninja test.txt 
ninja: no work to do. 

# æ›´æ”¹ä¾èµ–æ–‡ä»¶çš„å†…å®¹ã€‚
$ echo "DEP sample 1" > dep.txt

# å½“ä¾èµ–æ–‡ä»¶æ›´æ–°åï¼Œä¼šé‡æ–°ç”Ÿæˆç›®æ ‡æ–‡ä»¶ã€‚
$ ninja test.txt 
[1/1] echo "TEST `cat dep.txt`" > test.txt

# æ–‡ä»¶å†…å®¹ç¡®è®¤
$ cat dep.txt test.txt
DEP sample 1
TEST DEP sample 1
```

ä»¥ä¸Šå°±æ˜¯åŸºæœ¬çš„ç”¨æ³•ï¼Œéå¸¸ç®€å•æ˜äº†ã€‚

## ä¾èµ–å…³ç³»å›¾

æˆ‘å‘ç° Ninja æä¾›äº†ä¸€ä¸ªå¯ä»¥å°†æ–‡ä»¶ä¾èµ–å…³ç³»å¯è§†åŒ–ä¸ºç½‘ç»œå›¾å½¢çš„å·¥å…·ï¼Œéå¸¸æœ‰è¶£ï¼Œåœ¨æ­¤ä»‹ç»ä¸€ä¸‹ã€‚

ä½¿ç”¨ `ninja -t graph` é€‰é¡¹ï¼Œå¯ä»¥å°†æ–‡ä»¶ä¾èµ–å…³ç³»å›¾ä»¥ [graphviz](https://graphviz.org/) æ ¼å¼è¾“å‡ºã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥è¾“å‡ºå‰é¢ç¤ºä¾‹æ–‡ä»¶å¯¹åº”çš„ä¾èµ–å…³ç³»å›¾ã€‚

é¢„å…ˆå®‰è£… graphviz åï¼Œé€šè¿‡å°†è¾“å‡ºä¼ é€’ç»™ `dot` å‘½ä»¤ï¼Œå°±å¯ä»¥ç”Ÿæˆä¾èµ–å…³ç³»å›¾çš„å›¾ç‰‡ `graph.png`ã€‚

```sh
ninja -t graph | dot -Tpng -ograph.png
```

:::info
åœ¨ Ubuntu ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£… graphvizã€‚
```sh
sudo apt install graphviz
```
:::

å°†ä¼šç”Ÿæˆå¦‚ä¸‹çš„å›¾ç‰‡ã€‚  
ä¾èµ–æ–‡ä»¶å’Œç›®æ ‡ä»¥æ–¹å½¢èŠ‚ç‚¹æ˜¾ç¤ºï¼Œè€Œè§„åˆ™åˆ™ä»¥è¿çº¿è¿æ¥å®ƒä»¬ã€‚  
å¦‚æœæ²¡æœ‰ä¾èµ–æ–‡ä»¶ï¼Œåˆ™è§„åˆ™å°†ä»¥åœ†å½¢èŠ‚ç‚¹æ˜¾ç¤ºï¼Œå¹¶ä¸ç›®æ ‡ç›¸è¿ã€‚

![graph1](/img/blogs/2025/0122_build_system_ninja/sample_graph.png)

# å…¶ä»–è§„æ ¼æ€»ç»“

è¿˜æœ‰å…¶ä»–ä¸€äº›ä¾¿äºäº†è§£çš„è§„æ ¼ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ã€‚

## å˜é‡

åœ¨é…ç½®æ–‡ä»¶é¡¶å±‚ï¼Œå¯ä»¥ä»¥ `å˜é‡å = å­—ç¬¦ä¸²` çš„å½¢å¼å®šä¹‰å˜é‡ã€‚  
åœ¨å¼•ç”¨æ—¶ï¼Œå†™ä½œ `$å˜é‡å`ã€‚

```sh:ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
var = è±†è”µ

rule r
    command = echo $var

build tag: r
```

```sh:å®Ÿè¡Œçµæœ
$ ninja
[1/1] echo è±†è”µ
è±†è”µ
```

## è½¬ä¹‰

è½¬ä¹‰å­—ç¬¦æ˜¯ `$`ã€‚åœ¨ ninja.build æ–‡ä»¶ä¸­ï¼Œå¦‚æœæƒ³ä½¿ç”¨å…·æœ‰ç‰¹æ®Šæ„ä¹‰çš„å­—ç¬¦ï¼ˆç©ºæ ¼ã€`:`, `$` æœ¬èº«ã€æ¢è¡Œï¼‰ï¼Œå¯ä»¥åœ¨å…¶å‰åŠ  `$` è¿›è¡Œè½¬ä¹‰ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœè¦å°†å¤šä¸ªå‘½ä»¤æ¢è¡Œä¹¦å†™ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```sh
rule r4
    command = echo "r4 sample" $
    && echo "r4-12 sample"
```

## phony è§„åˆ™

Ninja å†…ç½®äº†ä¸€ä¸ªåä¸º `phony` çš„è§„åˆ™ã€‚

è¯¥è§„åˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œä½†å¯ç”¨äºä¸ºç›®æ ‡éšæ„æ·»åŠ ä¾èµ–å…³ç³»ã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥å¦‚ä¸‹å°† `foo` å®šä¹‰ä¸º `some/file.txt` æ–‡ä»¶çš„åˆ«åï¼š

```sh:ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
rule r1
    command = cat $in > $out

build some/file.txt: r1 dep.txt
build foo: phony some/file.txt
```

æ‰§è¡Œæ—¶å¯ä»¥æŒ‡å®šç›®æ ‡ä¸º `foo` è€Œé `some/file.txt`ï¼š

```sh:å®Ÿè¡Œçµæœ
$ ninja foo
[1/1] cat dep.txt > some/file.txt
```

æ­¤å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨è¯¥æœºåˆ¶åˆ›å»ºæ±‡æ€»å¤šä¸ªç›®æ ‡çš„ç»„ç›®æ ‡ã€‚

```sh:ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
rule r1
    command = echo "r1 sample"
rule r2
    command = echo "r2 sample"
rule r3
    command = echo "r3 sample"

build all: phony tag1 tag2 tag3
build tag1: r1
build tag2: r2
build tag3: r3
```

ä¾èµ–å…³ç³»å›¾å¦‚ä¸‹ï¼š

![phony](/img/blogs/2025/0122_build_system_ninja/phony_graph.png)

```sh:å®Ÿè¡Œçµæœ
$ ninja all
[1/3] echo "r1 sample"
r1 sample
[2/3] echo "r2 sample"
r2 sample
[3/3] echo "r3 sample"
r3 sample
```

## éšå¼ä¾èµ–

å¦‚å‰æ‰€è¿°ï¼Œè§„åˆ™å†…çš„å‘½ä»¤å¯ä»¥ä½¿ç”¨ `$in` å’Œ `$out` ç­‰å˜é‡ã€‚  
å…¶ä¸­ï¼Œ`$in` ä¼šå±•å¼€ä¸ºä¾èµ–æ–‡ä»¶åˆ—è¡¨ï¼Œ`$out` ä¼šå±•å¼€ä¸ºç›®æ ‡æ–‡ä»¶åˆ—è¡¨ã€‚  
å¦å¤–ï¼Œåœ¨æ–‡ä»¶æŒ‡å®šä¸­ï¼Œä½¿ç”¨ `|` åè·Ÿçš„æ–‡ä»¶ä¸ä¼šè¢«å±•å¼€ä¸ºè¿™äº›å˜é‡ã€‚

ä¸‹é¢å±•ç¤ºä¸€ä¸ªä½¿ç”¨ `|` çš„é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼š

```sh:ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
rule r1
    command = echo "DEP1 sample" > $out

rule r2
    command = echo "DEP2 sample" > $out

rule r3
    command = echo "TEST `cat $in`" > $out

build test1.txt | test2.txt: r3 dep1.txt | dep2.txt
build dep1.txt: r1
build dep2.txt: r2
```

ä¾èµ–å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![implicit_dep_graph.png](/img/blogs/2025/0122_build_system_ninja/implicit_dep_graph.png)

```sh:å®Ÿè¡Œçµæœ
$ ninja test1.txt -v
[1/3] echo "DEP1 sample" > dep1.txt
[2/3] echo "DEP2 sample" > dep2.txt
[3/3] echo "TEST `cat dep1.txt`" > test1.txt

$ cat dep1.txt dep2.txt test1.txt
DEP1 sample
DEP2 sample
TEST DEP1 sample
```

åœ¨æ‰§è¡Œ `r3` æ—¶ï¼Œ`$in` åªå±•å¼€ä¸º `dep1.txt`ï¼Œè€Œ `$out` åªå±•å¼€ä¸º `test1.txt`ã€‚  
å¦ä¸€æ–¹é¢ï¼Œ`dep2.txt` è¢«è¯†åˆ«ä¸ºä¾èµ–æ–‡ä»¶ï¼Œå› æ­¤ä¼šæ‰§è¡Œç”Ÿæˆ `dep2.txt` çš„è§„åˆ™ `r2`ã€‚

æ­¤å¤–ï¼Œå³ä½¿ç›´æ¥æ„å»ºéšå¼ç›®æ ‡ `test2.txt` ä¹Ÿä¸ä¼šç”Ÿæˆè¯¥æ–‡ä»¶ï¼Œä½†ä¾èµ–æ–‡ä»¶çš„ç”Ÿæˆè¿‡ç¨‹ä¼šè¢«æ‰§è¡Œã€‚

```sh:å®Ÿè¡Œçµæœ
$ ninja test2.txt -v
[1/3] echo "DEP1 sample" > dep1.txt
[2/3] echo "DEP2 sample" > dep2.txt
[3/3] echo "TEST `cat dep1.txt`" > test1.txt

$ cat dep1.txt dep2.txt test1.txt
DEP1 sample
DEP2 sample
TEST DEP1 sample

$ ls test2.txt
ls: cannot access 'test2.txt': No such file or directory
```

## Order-Only ä¾èµ–

åœ¨ä¾èµ–æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ `||` åæŒ‡å®šçš„æ–‡ä»¶ï¼Œä¼šç¡®ä¿è¯¥ä¾èµ–æ–‡ä»¶è¢«æ›´æ–°ï¼Œä½†ä¸ä¼šå‚ä¸ç›®æ ‡æ˜¯å¦éœ€è¦é‡å»ºçš„åˆ¤æ–­ã€‚

åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œå¯ä»¥åœ¨ç¡®ä¿ä¾èµ–æ–‡ä»¶æœ€æ–°çš„åŒæ—¶ï¼Œå‡å°‘ä¸å¿…è¦çš„ç›®æ ‡é‡å»ºã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢æ¯”è¾ƒäº†åœ¨ Order-Only ä¾èµ–ä¸é Order-Only ä¾èµ–ä¸‹çš„æ„å»ºè¡Œä¸ºã€‚

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå¯¹äºæ˜¯å¦é‡æ–°æ„å»º `test2.txt` çš„åˆ¤æ–­ï¼Œä¸ä¼šè€ƒè™‘ `dep2.txt` æ˜¯å¦æ›´æ–°ã€‚

```sh:ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
rule dep
    command = echo "DEP sample" > $out

rule test
    command = cat $in > $out

build test1.txt: test dep1.txt
build test2.txt: test || dep2.txt
build dep1.txt: dep
build dep2.txt: dep
```

ä¾èµ–å…³ç³»å›¾å¦‚ä¸‹ï¼š

![order_only_graph.png](/img/blogs/2025/0122_build_system_ninja/order_only_graph.png)

```sh:å®Ÿè¡Œçµæœ
# å‡è®¾ test1.txt å’Œ test2.txt å·²å­˜åœ¨ã€‚
$ touch test1.txt
$ touch test2.txt

# å½“é‡æ–°ç”Ÿæˆ test1.txt æ—¶ï¼Œç”±äº dep1.txt è¢«æ›´æ–°ï¼ˆæ­¤å¤„ä¸ºæ–°ç”Ÿæˆï¼‰ï¼Œtest1.txt çš„æ›´æ–°æ“ä½œå°†ä¼šæ‰§è¡Œã€‚
$ ninja test1.txt -v
[1/2] echo "DEP sample" > dep1.txt
[2/2] cat dep1.txt > test1.txt

# é‡æ–°ç”Ÿæˆ test2.txt æ—¶ï¼Œè™½ç„¶ dep2.txt è¢«æ›´æ–°ï¼ˆæ–°ç”Ÿæˆï¼‰ï¼Œä½†ä¸ä¼šæ‰§è¡Œ test2.txt çš„æ›´æ–°æ“ä½œã€‚
$ ninja test2.txt -v
[1/1] echo "DEP sample" > dep2.txt
```

## åŠ¨æ€ä¾èµ–æ€§

æ¥ä¸‹æ¥ä»‹ç»åŠ¨æ€æŒ‡å®šä¾èµ–æ–‡ä»¶çš„åŠŸèƒ½ã€‚

åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªç±»ä¼¼äº build è¯­å¥åˆ—è¡¨çš„æ–‡ä»¶æ¥è¡¨ç¤ºä¾èµ–æ€§ï¼Œå¹¶åˆ©ç”¨è¯¥æ–‡ä»¶æ·»åŠ ä¾èµ–å…³ç³»ã€‚

ä¸‹é¢çš„ä¾‹å­æ‘˜è‡ª [æ–‡æ¡£](https://ninja-build.org/manual.html#_tarball_extraction)ï¼Œç”¨äºå¤„ç† tar åŒ…çš„è§£å‹æ“ä½œã€‚  
åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œå¦‚æœ tar åŒ…è‡ªä¸Šæ¬¡è§£å‹ä¹‹åæœ‰æ›´æ–°ï¼Œå°†ä¼šé‡æ–°è§£å‹ã€‚  
æ­¤å¤–ï¼Œå³ä¾¿ tar åŒ…æ²¡æœ‰æ›´æ–°ï¼Œå¦‚æœä¹‹å‰è§£å‹å‡ºçš„æ–‡ä»¶å› æŸç§åŸå› ä¸å­˜åœ¨ï¼Œä¹Ÿä¼šé‡æ–°è§£å‹ã€‚

```sh:build.ninja
rule untar
  command = tar xf $in && touch $out
rule scantar
  command = scantar --stamp=$stamp --dd=$out $in
build foo.tar.dd: scantar foo.tar
  stamp = foo.tar.stamp
build foo.tar.stamp: untar foo.tar || foo.tar.dd
  dyndep = foo.tar.dd
```

è¿™ä¸ªè¿‡ç¨‹ç¨å¾®å¤æ‚ï¼Œä¸‹é¢æ¥ä¸€æ­¥æ­¥è§£é‡Šã€‚

é¦–å…ˆï¼Œå½“æ‰§è¡Œ `ninja foo.tar.stamp` æ—¶ï¼Œä¼šè¯„ä¼°ä»¥ä¸‹ build è¯­å¥ï¼š

```sh
build foo.tar.stamp: untar foo.tar || foo.tar.dd
  dyndep = foo.tar.dd
```

è¿™é‡Œçš„ `untar` æ˜¯è´Ÿè´£æ‰§è¡Œè§£å‹æ“ä½œçš„è§„åˆ™ï¼ŒåŒæ—¶ç”Ÿæˆç”¨äºè®°å½•æ—¶é—´æˆ³çš„ `foo.tar.stamp` æ–‡ä»¶ã€‚  
è€Œ `dyndep =` æ˜¯å†…ç½®å…³é”®è¯ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ–‡ä»¶ `foo.tar.dd` é¢„æœŸä¼šæŒ‰ç…§æŒ‡å®šæ ¼å¼[^dyndep_ref]æè¿°é¢å¤–çš„ç›®æ ‡å’Œä¾èµ–æ–‡ä»¶ã€‚è¿™ä¸ª `foo.tar.dd` ä¼šæ ¹æ® tar åŒ…çš„å†…å®¹åŠ¨æ€ç”Ÿæˆã€‚  
ä¸ºæ­¤ï¼Œæ­¤å¤„å°† `foo.tar.dd` æŒ‡å®šä¸º Order-Only ä¾èµ–ã€‚

[^dyndep_ref]:[dydepãƒ•ã‚¡ã‚¤ãƒ«ä»•æ§˜](https://ninja-build.org/manual.html#_dyndep_file_reference)

æ¥ä¸‹æ¥ï¼Œå°†è¯„ä¼°ä¸‹é¢çš„ build è¯­å¥ï¼Œç”¨ä½œ `foo.tar.dd` çš„æ„å»ºè¿‡ç¨‹ã€‚

```sh
build foo.tar.dd: scantar foo.tar
  stamp = foo.tar.stamp
```

è¿™é‡Œçš„ `scantar` æ˜¯å‡è®¾å·²ç»æä¾›çš„è™šæ‹Ÿå‘½ä»¤ã€‚è¯¥å‘½ä»¤è¯»å– tar åŒ…å†…å®¹ï¼Œå¹¶æ ¹æ®å†…å®¹ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œå¯¹ `tar tf` çš„è¾“å‡ºè¿›è¡Œå¤„ç†ï¼‰ï¼š

```sh:foo.tar.dd
ninja_dyndep_version = 1
build foo.tar.stamp | file1.txt file2.txt : dyndep
  restat = 1
```

å…¶ä¸­ï¼Œ`file1.txt` å’Œ `file2.txt` æ˜¯ tar åŒ…ä¸­åŒ…å«çš„æ–‡ä»¶åï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºï¼ˆéšå¼çš„ï¼‰ç›®æ ‡æ–‡ä»¶æ·»åŠ ã€‚

å¦‚æ­¤ä¸€æ¥ï¼Œå°±å¯ä»¥æ ¹æ® tar åŒ…çš„å†…å®¹åŠ¨æ€æŒ‡å®šä¾èµ–å…³ç³»ã€‚

ä¾èµ–å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚ï¼ˆæŒ‡ç¤º `file1.txt`ã€`file2.txt` çš„ç›®æ ‡èŠ‚ç‚¹å˜æˆäº†çœ‹èµ·æ¥è«åå…¶å¦™çš„æ•°å­—ï¼Œè¿™æ˜¯ä¸ª bug å—â€¦â€¦ï¼‰

![dyndep](/img/blogs/2025/0122_build_system_ninja/dyndep.png)

## å¹¶è¡Œæ‰§è¡Œ

Ninja é»˜è®¤ä»¥å¹¶è¡Œæ–¹å¼æ‰§è¡Œæ„å»ºã€‚

ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¸ä¼šäº§ç”Ÿæ–‡ä»¶çš„ç®€å•ä¾‹å­ï¼Œç”¨ä»¥ä¸‹é…ç½®æ–‡ä»¶å¯ä»¥è§‚å¯Ÿåˆ°å…¶è¡Œä¸ºã€‚

```sh:ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«
rule r1
    command = sleep 2 && echo "r1 `date +%H:%M:%S`"
rule r2
    command = sleep 2 && echo "r2 `date +%H:%M:%S`"
rule r3
    command = sleep 2 && echo "r3 `date +%H:%M:%S`"

build tag: phony tag1 tag2 tag3
build tag1: r1
build tag2: r2
build tag3: r3
```

ç›®æ ‡ `tag` ä¾èµ–äºä¸‰ä¸ªæ–‡ä»¶ `tag1`ã€`tag2`ã€`tag3`ï¼Œ  
è€Œè¿™ä¸‰ä¸ªä¾èµ–æ–‡ä»¶åˆ†åˆ«ç”±è§„åˆ™ `r1`ã€`r2`ã€`r3` æ‰§è¡Œï¼Œåœ¨è¿è¡Œæ—¶éƒ½ç­‰å¾… 2 ç§’åè¾“å‡ºå½“å‰æ—¶é—´ã€‚

```sh:å®Ÿè¡Œçµæœ
$ ninja tag
[1/3] sleep 2 && echo "r1 `date +%H:%M:%S`"
r1 19:49:04
[2/3] sleep 2 && echo "r2 `date +%H:%M:%S`"
r2 19:49:04
[3/3] sleep 2 && echo "r3 `date +%H:%M:%S`"
r3 19:49:04
```

ä»è¾“å‡ºçš„ç§’æ•°å¯ä»¥çœ‹å‡ºï¼Œå®ƒä»¬æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå› æ­¤å…¨éƒ¨åœ¨åŒä¸€æ—¶åˆ»è¾“å‡ºã€‚

# å…³äºå·¥å…·é€‰é¡¹

å¦‚å‰æ–‡æ‰€è¿°ï¼Œåœ¨è¾“å‡ºä¾èµ–å…³ç³»å›¾æ—¶å°±ç”¨åˆ°äº†ï¼Œninja å‘½ä»¤ä¸­æä¾›äº†é€šè¿‡ `-t` é€‰é¡¹ä½¿ç”¨çš„ä¾¿æ·å·¥å…·ï¼ŒåŒ…æ‹¬ï¼š

- browse  
  - å¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºä¾èµ–å…³ç³»å›¾  
  - `ninja -t browse --port=8000 --no-browser mytarget`ï¼ˆåœ¨æˆ‘è¿™é‡Œæ‰§è¡Œæ—¶ç«Ÿç„¶æŠ¥é”™ğŸ’¦ï¼‰
- graph  
  - ä»¥ graphviz æ ¼å¼è¾“å‡ºä¾èµ–å…³ç³»å›¾  
  - `ninja -t graph mytarget | dot -Tpng -ograph.png`  
  - ä½¿ç”¨ `sudo apt install graphviz -y` å®‰è£… dot
- targets  
  - è¾“å‡ºç›®æ ‡åˆ—è¡¨
- commands  
  - è¾“å‡ºç»™å®šç›®æ ‡çš„å‘½ä»¤åˆ—è¡¨
- inputs  
  - è¾“å‡ºç»™å®šç›®æ ‡çš„è¾“å…¥æ–‡ä»¶åˆ—è¡¨
- clean  
  - åˆ é™¤æ„å»ºäº§ç‰©

# ç»“è¯­

æœ¬æ–‡æ€»ç»“äº†å¯¹æ„å»ºç³»ç»Ÿå·¥å…· Ninja çš„ä½“éªŒå†…å®¹ã€‚  
è¿˜æœ‰è®¸å¤šç»†èŠ‚è§„æ ¼ï¼Œå¦‚æœæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚é˜… [æ‰‹å†Œ](https://ninja-build.org/manual.html)ã€‚  
æ­£å¦‚å…¶è®¾è®¡ç›®æ ‡æ‰€è¿°ï¼ŒåŸºæœ¬ä¸Šä¸å»ºè®®æ‰‹å·¥ç¼–å†™ Ninja é…ç½®æ–‡ä»¶ï¼Œä½†äº†è§£å…¶ä¹¦å†™æ–¹å¼å’Œæ‰§è¡Œæ–¹æ³•è¿˜æ˜¯éå¸¸æœ‰è¶£çš„ã€‚  
ç‰¹åˆ«æ˜¯èƒ½å¤Ÿè¾“å‡ºä¾èµ–å…³ç³»å›¾è¿™ä¸€åŠŸèƒ½ï¼Œéå¸¸å®ç”¨ï¼Œä»…å‡­è¿™ä¸€ç‚¹å°±èƒ½æ´¾ä¸Šä¸å°‘ç”¨åœºã€‚  
ç›¸æ¯” Makefileï¼ŒNinja åœ¨ä¾èµ–å…³ç³»è§£æä¸Šçš„é€Ÿåº¦è¦å¿«å¾—å¤šï¼Œå› æ­¤å¦‚æœæœ‰æœºä¼šï¼Œæˆ‘ä¸€å®šä¼šå°è¯•ä½¿ç”¨å®ƒã€‚
