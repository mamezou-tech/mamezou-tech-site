---
title: ロボットマニピュレータ制御のアルゴリズム3
author: takahiro-ishii
date: 2024-07-09
tags: [ロボット, マニピュレータ, アルゴリズム, 軌跡生成, 逆運動学, ヤコビ行列, 同次行列, 特異点, 特異点回避]
image: true
prevPage: ./src/posts/robotics/manip-algo/manip-algo.md
---
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({
 tex2jax: {
 inlineMath: [['$', '$'] ],
 displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
 }
 });
</script>

# ロボットマニピュレータ制御のアルゴリズム3
(株)豆蔵　エンジニアリングソリューション事業部　石井隆寛

## 1. はじめに
（株）豆蔵では様々なロボット技術を開発している。他社製ロボットを用いてクライアントの要望に応える応用技術を開発することが多いが、自社でも6軸や7軸のアームを持つ産業用ロボット、いわゆるロボットアーム＝マニピュレータを一から開発している。この開発を通じて様々な応用技術や提案を生み出している。今回ここで得た知見を読者の方と共有したいと思う。本解説では6軸の産業用垂直多関節型マニピュレータを例にしてこれを制御するさまざまなしくみを説明したい。

今回は、これまで説明してきた[軌跡生成処理アルゴリズム][1]を適用してロボットアームを動作させたとき、必ず問題となる「特異点」について理論も含めて解説する。また、その解決方法、いわゆる「特異点回避」の方法の一例を紹介する。

[1]:https://developer.mamezou-tech.com/robotics/manip-algo2/manip-algo2/


## 2. ロボットアームの特異点
## 特異点とは？
これまで述べてきたようにロボットアームは6軸を動かすことにより様々な姿勢をとり、ツール先端位置/姿勢を変えることができる。しかしある特定の姿勢に近づく、あるいは遠ざかるとき、突然一部のアームが急激な動作をとりサーボモータや減速機に無理な負荷をかけたり、大きな振動を生じさせたりすることがある。その状態をロボットアームの「特異点」と呼ぶ。本稿で取り上げている6軸の産業用垂直多関節型マニピュレータの場合、経験的に下記の3つの特異点が知られている。

1. Shoulder特異点
2. Elbow特異点
3. Wrist特異点

下記のようなマニピュレータのジオメトリにおいて、（※Z軸は各関節での回転軸）
![](img/robotics/manip-algo3/robo-geom.png)

これら3つの特異点は下記のように定義されている。

![](img/robotics/manip-algo3/singularity.png)

これらの特異点の姿勢に近くなると、アームの動きに不都合が生じる。例えば、「3.Wrist特異点」の姿勢からツール先端を先端の向きは変えないようZ4軸（Bn軸）方向（この絵では紙面の上下方向）にゆっくりと移動させると、P3とP4の間のアームがZ3軸（Rt軸）周りに急激に回転する。この回転角度は一瞬で90度近くになる。このときP3より先にある部材はかなりの重量があるのでRt軸のサーボモータに急激な負荷がかかり、場合によっては大きな振動を発生することがある。

## 特異点の数学的説明

以上のような特異点とは一体何なのか数学的に説明してみよう。
まず以前に説明した、「速度の順運動学/逆運動学計算」で紹介したヤコビ行列とその利用方法を再掲する。

* $\vec{P_t}$：ツール先端位置 
* $\vec{P_0}$：ベース座標系原点位置
* ”$\times$"はベクトル積
* 右肩のＴは行列の転置を表す。

$$
J=\left(
\begin{array}{ccccc}
 [\vec{Z_0} \times (\vec{P_t}-\vec{P_0})]^T & [\vec{Z_1} \times (\vec{P_t}-\vec{P_1})]^T & [\vec{Z_2} \times (\vec{P_t}-\vec{P_2})]^T & ... &[\vec{Z_5} \times (\vec{P_t}-\vec{P_5})]^T\\
 \vec{Z_0}^T  & \vec{Z_1}^T & \vec{Z_2}^T & ... & \vec{Z_5}^T\\
 \end{array}
\right)
$$

このヤコビ行列を用いて下記のように関節軸速度からツール先端の並進速度と回転速度が計算できる。
* $\omega_i$ {i=1,2,...,6}：各関節軸での角速度
* $\vec{v_t}$：ツール先端の3次元並進速度ベクトル
* $\vec{w_t}$：ツール先端の3次元回転速度ベクトル
* $\vec{\omega}$:各関節軸の角速度を表す6次元縦ベクトル
* $\vec{v}$:ツール先端の速度を表す6次元縦ベクトル
  

$$
\Omega=( \omega_1, \omega_2 , \omega_3 , \omega_4 , \omega_5 , \omega_6  )
$$
$$
\vec{\omega}=\Omega^T
$$
$$
\vec{v}=
\left(
\begin{array}{c}
 {\vec{v_t}^T} \\
 {\vec{w_t}^T} \\
 \end{array}
\right)
$$
$$
\vec{v}=J \vec{\omega}
$$
$$
\vec{\omega} =J^{-1} \vec{v}
$$
$J$はロボットアームの瞬間的な姿勢で決まるが、これの逆行列 $J^{-1}$が求まらないことがある。このときツール先端の移動量がどうであれ、関節軸の回転量が不定となる。そもそも逆行列の要素を求めるときは、行列式の値で割る操作が必要なので$J^{-1}$が求まらないということは行列式が0、
$$
det[J] = 0
$$
と同義である。それがまさに特異点をとる姿勢である。一方特異点近くの姿勢においては行列式は0に近いが0とはならないため一応$J^{-1}$は求まる。しかしその要素は$det[J]$で割ったものであるため巨大な数値になりえる。そのため
$$
\vec{\omega} =J^{-1} \vec{v}
$$
を計算すると、ツール先端の移動量$\vec{v}$が小さくても関節角度の変化量$\vec{\omega}$の要素が巨大となる。これが特異点近傍で一部のアームが異常な動作を引き起こす理由である。

## 特異点回避
### 回避方法
以上のように特異点付近では動作に問題があるため、これらの特異点を何とか回避する方法が考えられてきた。主に以下の方法がある。

1. 特異点に近づくと本来の軌跡（ツール先端の経路や向き）をやや変える。
2. 特異点に近づくと本来の軌跡を変えないよう全モータの速度を一律に急速に落とす。

上記1.の方法では事前に計画した動作時間通りに動く半面、本来の軌跡から逸脱するため精度が損なわれる。また2.の方法では計画通り正確な軌跡をたどるが、事前に予定した時刻よりかなり遅れた動作になってしまう。

産業用ロボットマニピュレータは、工場などの生産現場で使用されることが多いため、時間節約の問題は重要である。また、精度が要求される重要な軌跡では特異点にならないよう、また単なるツールの移動場面でのみ特異点になるよう、気を付けてプログラミングすれば、1.の方法のほうが望ましい。本稿では弊社で採用した1.の方法の一例を説明する。（参考文献１参照）


### スプライン曲線
3点以上のKP、いいかえれば連続で2区間以上が指定されるとき区分3次スプライン補間による滑らかな位置の3次元軌跡を得ることができる。


まず区間$m$に関して、下記のようにパラメータを$s$とする区分3次スプライン補間式を定める。

$$\vec{F}_m(s) = \vec{a}_m + \vec{b}_m*(s-m) + \vec{c}_m*(s-m)^2 + \vec{d}_m*(s-m)^3 　$$

これを下記の条件が成立するよう、任意の$m$において連立方程式をたて、係数 $\vec{a}_m, \vec{b}_m, \vec{c}_m, \vec{d}_m$を未知数として方程式を解く。この求解は一意の計算で実行可能である。

1. ０次連続：
    
	$$\vec{P}_{KP[m]}=\vec{F_m}(m);~ \vec{P}_{KP[m+1]}=\vec{F_m}(m+1);~... $$

2. １次連続：KPでの接線の傾きが連続 
   
	$$\frac{d\vec{F}_{m-1}(m)}{ds}=\frac{d\vec{F}_{m}(m)}{ds};~ \frac{d\vec{F}_m(m+1)}{ds}=\frac{d\vec{F}_{m+1}(m+1)}{ds} ;~...　
	$$

3. ２次連続：KPでの曲率が連続 
   
	$$\frac{d^2\vec{F}_{m-1}(m)}{ds^2}=\frac{d^2\vec{F}_{m}(m)}{ds^2};~ \frac{d^2\vec{F}_m(m+1)}{ds^2}=\frac{d^2\vec{F}_{m+1}(m+1)}{ds^2};~... $$

4. 開始KPと終了KPでは接線の傾きは不定, 曲率は0とする。

こうして求めた係数を用いて$\vec{F}_m(s)$を確定後、$s$をサンプルして漸次$\vec{F}_m(s)$を計算すればサンプル点列として軌跡が求まる。このとき
$$m=\rm{floor}(s)$$
とする。この軌跡はKPを貫通する滑らかな３次元曲線である。

### 円弧
3点のKP、いいかえれば連続で2区間が指定されると円弧状の滑らかな3次元軌跡を得ることができる。3点が通る円の中心と半径を求め、中心からの移動角度でサンプリングすることで円弧軌跡を算出できる。


実際、この計算を３次元空間上でストレートに処理するのは困難なので、一旦２次元に投影して考える。下記の図でUV座標系はKP$_{[m]}$を原点にして、KP$_{[m-1]}$がU軸に乗るよう、またKP$_{[m+1]}$がUV平面に乗るように配置したものである。


これを定式化すると、下記のようになる。
$$\vec{v}_a=\vec{P}_{KP[m-1]}-\vec{P}_{KP[m]}$$
$$\vec{v}_b=\vec{P}_{KP[m+1]}-\vec{P}_{KP[m]}$$
$$\vec{U}=\vec{v}_a/|\vec{v}_a|$$
$$\vec{W}=\frac{\vec{v}_a \times \vec{v}_b}{|\vec{v}_a||\vec{v}_b|}$$
$$\vec{V}=\vec{W} \times \vec{U} $$

これで、UVW座標系から$\Sigma_0$座標系に変換する4x4の同次行列$T^{WC}_{UV}$を算出できる。つまり、行列の回転行列部に$\vec{U},\vec{V},\vec{W}$、平行移動部に$\vec{P}_{KP[m]}$を代入する。

さらに$\vec{v}_a$と$\vec{v}_b$とのなす角度を内積の公式を用いて算出すれば、UV座標系上で3個のKPの2次元座標$Q_0,Q_1,Q_2$が求まる。そこでUV座標系にてこれら3点を通る円の半径$R$と中心座標$Q_c(U_c, V_c)$を解析的に導出できる。同様に$Q_c$を中心とした回転移動角度$th_0$と$th_2$も計算できる。
ここで、さらに図のように$Q_c$を原点として、$Q_1$方向にu軸を置いたuv座標系を規定する。UVW座標系上でu軸、v軸、w軸はそれぞれ
$$
\begin{align*}
& \vec{u}= (-U_c/R, -V_c/R,0 ) \\
& \vec{v}= ( V_c/R, -U_c/R,0) \\
& \vec{w}= (0,0,1)
\end{align*}
$$
と表すことができる。これで、uvw座標系からUVW座標系へ変換するための同次変換行列$T^{UV}_{uv}$が得られる。

以上からuvw座標系からベース座標系$\Sigma_0$への同次変換行列$T^{WC}_{uv}$は
$$T^{WC}_{uv} = T^{WC}_{UV} T^{UV}_{uv}$$
とすることで算出できる。

さてuvw座標系上で$Q_0$を開始点とする円弧のパラメータ表示は
$$ 
\left(
\begin{array}{ccc}
u \\ v \\ w
\end{array}
\right)
=　\left(
\begin{array}{ccc}
R~ \rm{cos}(-\theta) \\
R~ \rm{sin}(-\theta)\\
0
\end{array}
\right)

$$
となるため、θを$-th_0$から$th_2$まで順にサンプルして、$T^{WC}_{uv}$を使って座標変換すれば3次元上での円弧のサンプル点列を算出できる。

## 区間内姿勢軌跡
これまで直観的にわかりやすいツール先端「位置」に関して軌跡の導出方法あるいは補間方法を説明してきた。これに対して「姿勢」もKP間で連続的に変化するよう補間が必要であり、軌跡を構成する重要なサンプル情報である。「姿勢」とはツール先端の状態を表す4x4の同次行列の左上3x3の回転行列部$R$であり、9個の数値であることはすでに説明した。これら9個の数値を正規直交系を保ちながら、姿勢間でうまく補間するのは難しい。そのため古くはこれら9個の数値を一旦オイラー角つまり3つの角度を表すベクトルに変換し、角度ベクトル間を適当に補間する方法がとられていた。しかし、この方法では3つの角度の異方性のために自然な補間にならず効率的な姿勢移動ができなかった。また、ジンバルロックの対処が困難であった。

そのため昨今ではKPで設定される3次元空間での姿勢やその回転操作を四元数$\bold{q}$（Quaternion）で表現し、それらの間で補間処理を行うことが普通である。なお、回転を表すには長さ1の単位Quaternionを利用する。

補間処理を行う手続きは以下のようになる。

1. 補間したい区間mに属するKP[m],KP[m+1],...での姿勢を示す回転行列$R$[m],$R$[m+1],...を各々Quaternion $\bold{q}_{[m]}$, $\bold{q}_{[m+1]}$, ...に変換
2. $\bold{q}_{[m]}$, $\bold{q}_{[m+1]}$, ...の間が滑らかになるよう補間してサンプル$\bold{q}_{[m]}(s_i)$を生成
3. $\bold{q}_{[m]}(s_i)$を順次$R_{[m]}(s_i)$に逆変換

参考として上記1の$R$から$\bold{q}$へ変換するコード例を以下に示す。
```cpp
///////////////////////////////////////////////////////////
/// @brief		行列（3x3）からクォータニオンを計算して設定
/// @param[in]	_matrix
/// @return		なし
/// @note
///////////////////////////////////////////////////////////
void Quaternion::SetR3x3(const Matrix& _matrix)
{

	m33 = 1.0 - qxx - qyy;
}
```
### 球面線形補間（$\rm{Slerp}$）
ある姿勢$\bold{q}_{[m]}$から$\bold{q}_{[m+1]}$まで最短で回転移動しながら補間するのが球面線形補間(Spherical linear interpolation)である。イメージとしては、4次元単位球の表面上においた2つの$\bold{q}$点の間を大円を描くように球表面をなぞる曲線に沿ってゆくような感じである。このとき移動角度で前後の$\bold{q}$を案分するので、変化させるパラメータsと実際の回転量が比例する。


具体的には下記の手続きで区間mでのQuaternion $\bold{q}_{[m]}(s)$を得る。

まず、Quaternion間のなす角度("$\cdot$"は内積を表す)
$$
\theta = \rm{cos}^{-1}(\bold{q}_{[m]} \cdot \bold{q}_{[m+1]}) \\
$$
を算出する。次にパラメータ$s$ $(m\le s \le m+1)$に対して重み
$$
r(s)=s-m \\
$$
を得る。このとき、$\theta \le \frac{\pi}{2}$ならば
$$
\begin{align*}

&k_s(s)=\rm{sin}((1-r(s)) ~ \theta)/\rm{sin}(\theta) \\
&k_e(s)=\rm{sin}(\theta~ r(s))/\rm{sin}(\theta) \\
&\bold{q}_{[m]}(s)=k_s(s)~\bold{q}_{[m]} + k_e(s)~\bold{q}_{[m+1]} \\

\end{align*}
$$
それ以外、$\theta \gt \frac{\pi}{2}$のときはQuaternion の逆向き同義性を利用して
$$ 
\begin{align*}
&\theta' = \pi-\theta\\
&k_s(s)=\rm{sin}((1-r(s)) ~ \theta')/\rm{sin}(\theta') \\
&k_e(s)=\rm{sin}(\theta' ~ r(s))/\rm{sin}(\theta') \\
&\bold{q}_{[m]}(s)=k_s(s)~\bold{q}_{[m]} - k_e(s)~\bold{q}_{[m+1]} \\

\end{align*}
$$
と計算する。
この処理の一部は整理して関数化でき、下記のように定義できる。
すなわち、$\bold{q}_0$から$\bold{q}_1$までの線形変化で案分率rのQuaternionは$\rm{Slerp}$関数を使用して$\bold{q}$と計算される。
$$
\bold{q} =\rm{\rm{Slerp}}(r, \bold{q}_0,\bold{q}_{1} ) \\
~ (0 \le r \le 1)
$$


## 区間境界での平滑化
区間の境界付近で位置も姿勢も滑らかに変化するような軌跡の修正方法について述べる。このとき修正された軌跡は区間境界に置かれたKPの位置/姿勢をもはや正確にトレースできなくてよい。

### 必要性
例えば、ある区間で直線を、次の区間では円弧の軌跡が指定された場合を考えよう。ツール先端が問題なく動作するためには2つの区間の境界に置かれたKPにおいて速度を0にし、その前に適度な減速、その後適度な加速を行うようにする。こうすれば、当該KPで軌跡が折れ曲がっていても（=1次非連続かつ2次非連続）瞬間に一旦停止するので関節軸の作動に無理をかけない。しかしながら、できるだけ当該KP付近を高速に通過したい場合、一旦停止はせずツール先端速度をなるだけキープして移動した方がよい。そのためにはどうしてもKP前後の軌跡を滑らかにつなげる必要がある。これは位置の軌跡だけのことでなく姿勢の軌跡についても同様である。

### 滑らかな位置/姿勢軌跡のあてはめ方式
#### 位置軌跡のあてはめ
一度前後の区間で指定された軌跡曲線を描いてみて、あとから滑らかに接続するように適当な曲線を当てはめる方法である。例えば下記のようにKP$_{[m]}$を区間境界とする場合、一度KP$_{[m]}$の前後の区間m-1と区間mで軌跡曲線を引き、KP$_{[m]}$から当該曲線上に沿って、適当な距離（$L_1$, $L_2$）にあるサブポイントKP$_{[m]1}$とKP$_{[m]2}$を考える。各ポイントでの位置を$\vec{Q}_1$, $\vec{Q}_2$、接線ベクトルを$\vec{V}_{q1}$, $\vec{V}_{q2}$として、これらを利用することにより3次スプライン補間式$\vec{F}_0(s) ~~ (s=0～1)$をサンプリングして、平滑曲線とする方法がある。


この曲線あるいは補間式の求め方は前述したスプライン曲線の求め方とよく似ている。しかし区分は１つで、境界条件も異なってくる。それは次のようになる。

まず3次スプラインの補間式$\vec{F}_0(s)$を再掲する。

$$\vec{F}_0(s) = \vec{a}_0 + \vec{b}_0*s + \vec{c}_0*s^2 + \vec{d}_0*s^3 　$$

これを下記の条件が成立するよう、連立方程式をたて、係数 $\vec{a}_0, \vec{b}_0, \vec{c}_0, \vec{d}_0$を未知数として方程式を解く。この求解も一意の計算で実行可能である。

1. ０次連続：

	$$\vec{Q}_1=\vec{F_0}(0);~ \vec{Q}_{2}=\vec{F_0}(1)$$
2. １次連続：KPでの接線の傾きが連続 
   
	$$\vec{V}_{q1}=\frac{d\vec{F}_0(0)}{ds};~ \vec{V}_{q2}=\frac{d\vec{F}_0(1)}{ds}$$


以上をまとめると、

1. KP$_{[m-1]}$からKP$_{[m]1}$までは区間m-1での元の軌跡を使い、
2. KP$_{[m]1}$からKP$_{[m]2}$までは上記スプライン曲線を使い、
3. KP$_{[m]2}$からKP$_{[m+1]}$までは区間mでの元の軌跡を使う

ことにより、滑らかに連続した一連の軌跡となる。滑らかにしたいKPからの距離$L_1$と$L_2$を調整することにより平滑の具合を調整できるのがこの方法の特徴である。このとき速度プロファイル（正確には速度ベクトルのノルムのプロファイル）においても変形が必要である。元の2区間分の2つの速度プロファイルを並べたあとKP$_{[m]1}$からKP$_{[m]2}$までの間は、

1) なるべく一定速度で移動する。
2) 正確にスプライン曲線の距離分移動する。

ように変形を加える。なお、距離とは速度プロファイルの積分、つまり区間の面積に相当することに注意。

ところで、本方式では1か所の平滑化を施すために、計算の最初に2本分の軌跡データが必要であるが、結局その一部は後に不要となる。その分の計算負荷とメモリが負担となることを実装時には留意されたい。

#### 姿勢のあてはめ
前後の姿勢軌跡が全域で滑らかに変化するよう一部の軌跡を滑らかにする方法である。例えば、下記のような方法がとれる。


KP$_{[m]}$を区間境界として、$\bold q_{[m-1]}$,  $\bold q_{[m]}$, $\bold q_{[m+1]}$がそれぞれKP$_{[m-1]}$、KP$_{[m]}$、KP$_{[m+1]}$でのQuaternionとして、

$$
\begin{align*}
& \bold q_{[m]1} = \rm{Slerp}(1-w, \bold q_{[m-1]}, \bold q_{[m]} ) \\
& \bold q_{[m]2} = \rm{Slerp}(w, \bold q_{[m]}, \bold q_{[m+1]} )
\end{align*}
$$
を算出する。ここで、$w$は比較的小さな値(0.3くらい)である。そのため、$\bold q_{[m]1}$は区間m-1の途中でややKP$_{m}$よりの姿勢、また$\bold q_{[m]2}$は区間mの途中でややKP$_{m}$よりの姿勢になる。このあと下記の補間方法で滑らかな姿勢変化の軌跡$\bold q$を計算する。
すなわち
$$
\begin{align*}
& \bold q_1 = \rm{Slerp}(t, \bold q_{[m]1}, \bold q_{[m]} ) \\
& \bold q_2 = \rm{Slerp}(t, \bold q_{[m]}, \bold q_{[m]2} )　\\
& \bold q = \rm{Slerp}(t, \bold q_1, \bold q_2 )　\\
\end{align*}
$$
このときパラメータtを0から1まで変化させながら、$\bold q$を漸次サンプルすれば、滑らかなQuaternion列が求まる。これを区間m-1の大円円弧のうち$\bold q_{[m-1]}～\bold q_{[m]1}$部分と区間mの大円円弧のうち$\bold q_{[m]2}～\bold q_{[m+1]}$部分とを合わせて滑らかな姿勢の軌跡とする。

### 速度重ね方式

これまで述べた平滑化とは別の発想で生まれた平滑化の手法である。平滑化したい対象KPの前後区間での元の速度"ベクトル"プロファイル例を下記の図の上側に示す。左半分は後方（時間をさかのぼる方向）の区間での軌跡上をツール先端が動く時の通常の速度ベクトルの時系列であり、台形制御となっている。また右半分は前方（時間が流れる方向）の区間の速度ベクトルの時系列であり、これも台形制御となっている。2つの境界にあたる対象のKP付近で滑らかな動きにしようとすれば前の台形と後ろの台形をずらして合成すればよい。それを下側で示す。この図では速度ベクトルプロファイルを一部重ねたような速度制御となる。このような速度制御となるように元の前後の軌跡を補間することにより、滑らかな位置/姿勢の軌跡にするのが速度プロファイル重ね方式、略して速度重ね方式(OVV=OVerlapped Velocity)である。


ここで前方側の台形（右半分）を後方（左方向）にずらす時間をoverlap時間$t_{ov}$とする。これを大きくすればなるべく速度を落とさず当該KP付近を$t_{ov}$分、短時間に通過できる。

さて一般的に、下記の式のように速度$\vec {V}$の時間積分で位置$\vec{P}(t)$が算出できる。
$$
\vec{P}(t) =\int_{ts}^{te} \vec{V}(t) dt　+\vec {P}_s
$$

この関係をうまく利用すれば元の軌跡曲線の位置・姿勢の時系列から速度重ねの状態を表す滑らかな時系列を算出できる。


ここでは具体的な証明はしないが、次のような結論を得る。上記図のような状態で$\vec{P}(t)$、$\bold{R}(t)$を時刻tのときの位置（3次元ベクトル）、姿勢（3x3の回転行列）とすると、速度重ね状態の軌跡の補間式は
$$
\begin{align*}
&(t_m-t_{ov}) \lt t \le t_m  のとき\\
&\vec{P}(t)=\vec{P}_b(t) + \vec{P}_f(t+t_{ov})- \vec {P}_2 \\
&\bold{R}(t)=\bold{R}_f(t+t_{ov})~ \bold{R}^{-1}_2~ \bold{R}_b(t) \\
\end{align*}
$$
と簡単に表せる。なお、$t_m$は元の軌跡をたどったとき、KP$_{[2]}$(=$\vec{P}_2$, $\bold{R}_2$)に到達する時刻である。

従って、時系列サンプルデータがある場合は次のような簡単な処理で平滑化サンプルが得られる。元の軌跡をjでサンプルした前後の位置の時系列$\vec{P}_f[j], \vec{P}_b[j]$、また前後の姿勢の時系列$\bold{R}_f[j], \bold{R}_b[j]$がすでに用意されており、

$$\begin{align*}
& \Delta t：時刻サンプル幅 \\
& j_m：KP[2]でのサンプル点\vec{P}_b[j]または\bold{R}_b[j]のインデックス \\
& ~~~~~\iff  \vec{P}_b[j_m]=\vec{P}_2かつ \bold{R}_b[j_m]=\bold{R}_2　\\
& nj = \rm{round}(\frac{t_{ov}}{\Delta t}) ：overlap時間分のサンプル数\\
\end{align*}$$

とすれば、平滑部は
$$
\begin{align*}
& (j_m-nj) \lt j \le j_m  のとき\\
& \vec{P}[j]=\vec{P}_b[j] + \vec{P}_f[j+nj]- \vec {P}_2 \\
& \bold{R}[j]=\bold{R}_f[j+nj]~ \bold{R}^{-1}_2 ~\bold{R}_b[j] \\
\end{align*}
$$

と補間計算が可能である。直線、円弧、スプラインなどのCP制御の区間と区間の間で平滑化したい場合はこれらの方法が使える。またPTP制御（関節軸主体制御）の区間と区間の間の平滑化の時は$\vec{\Theta}$を$\vec{P}$の代わりに用いれば同じことが可能である。また区間の片方がCP制御もう片方がPTP制御のときはどちらかの制御軌跡に統一した後、本方式を適用することが可能である。

ところで、本方式でも1か所の平滑化を施すために、計算の最初に前後2本分の軌跡データ（しかも時系列サンプルデータ）が必要であるが、結局その一部は後に不要となる。その分の計算負荷とメモリが負担となることを実装時には留意されたい。

## 4. 終わりに

実用的な軌跡生成の方法、また境界付近での平滑化について解説した。ロボットアームにプログラムを与えて動作指示をしたとき、内部でいかなる計算が行われ軌跡生成しているのか、その端緒を示すことができたと思う。実際の実装では、これらを実機で動作させてみて工夫を加えたアルゴリズムに改良したり、高速化や安定化のための改善策を追加したり、例外処理を追加する。

次回は特異点と呼ばれるロボットアームの厄介な特殊姿勢とその回避方法について解説する。


##  参考文献

1. 中村仁彦, 花房秀郎、「関節形ロボットアームの特異点低感度運動分解」, 計測自動制御学会論文集 第20巻 第5号 ( 昭和59年5月 )
2. 遠山 茂樹 (著)、　「ロボット工学 (メカトロニクス教科書シリーズ)」、コロナ社 (1994)
以上
