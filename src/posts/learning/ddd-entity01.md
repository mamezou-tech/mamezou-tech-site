---
title: DDDざっくり解説　エンティティ編
author: atsushi-esaka
date: 2022-12-12
tags: [DDD,初心者向け]
---


## はじめに
　この記事は、豆蔵教育で行なっているドメイン駆動設計(以下、DDD)入門講座の一部を抜き出して説明します。今回は、エンティティを理解するうえでおさえておきたいポイントをざっくりと説明します。本記事の内容がエンティティのすべてではありませんが、今後DDDを理解するための足掛かりになればと思います。さらに、この説明の過程で豆蔵ではどういった教育を行なっているのか知って頂き、少しでも興味を持って頂ければ幸いです。

* 対象者：「DDDを勉強してみて、エンティティという言葉は知っているものの、結局のところそれが何なのかイマイチ分からない。」というような方
* 目標：エンティティについてなんとなく理解し、この理解を今後のDDDの学習の足掛かりにして頂くこと


[[TOC]]

## 豆蔵教育のドメイン駆動設計入門講座
　豆蔵教育では、ドメイン駆動設計入門という講座を実施しています。この講座は、DDDの原著であるエヴァンス本[1]に基づいて初学者向けにDDDの概要と主にモデル駆動設計について解説をしています。モデル駆動設計についてだけ、といったように、DDDの一部をかいつまんで実践することを、一般に軽量DDDと呼びます。実践ドメイン駆動設計[2]で述べられているように、軽量DDDは、DDDの誤用であり、DDDの恩恵を十分に受けることは出来ません。とはいえ、この講座は初学者向け(特に新入社員)の研修コースの一部であり、また、DDDをすべて学習をするには時間的にも限界があります。そこで、講座に付随する演習において、特定の業務を想定し、ユビキタス言語や境界付けられたコンテキストについても取り入れてモデリングを行うこととしています。これによって、戦略的モデリングを表層的にでも体感しながら、全体的なドメインモデル設計のポイントを学べるようにしています。

<img src="/img/edu/ddd-entity-edu.png" width="700">
<br>

　デベロッパーサイトの記事としてこの講座の内容すべてを説明するのは、ボリュームも膨大になってしまいますので、今回はエンティティについて、教育経験も踏まえて説明できればと思います。本記事は対象を、「DDDを勉強してみて、エンティティという言葉は知っているものの、結局のところそれが何なのかイマイチ分からない。」というような方とし、目標を、エンティティについてなんとなく理解し、この理解を今後の学習の足掛かりにして頂くこととします。今後、機会があれば、値オブジェクト、サービス等の説明や、ユビキタス言語とは？モデル駆動設計とは？そもそもDDDを導入することで何が嬉しいのか？といったことをも連載できればと思っています。どうぞよろしくお願いいたします。

## エンティティとその理解の難しさ

　DDDにおけるエンティティとは、ざっくり言ってしまえば、「どれ・だれ」、「だれの」というように識別されるモノがドメイン知識として重要である場合に、これを強調してソフトウェアとして表現するためのノウハウ(※1)、または、このノウハウにしたがって導出されたオブジェクトのことを指します(以下、オブジェクトを指す場合は、エンティティオブジェクトと区別して記述します)。さらにざっくりと言ってしまえば、様々な状況において、「どれ・だれ」、「だれの」というように識別されるような性質のことを「同一性」と呼びます。
<img src="/img/edu/ddd-entity-identity.png" width="500">

　私のこれまでの研修経験からすると、エンティティを理解できない場合、その理由の多くは「同一性が理解できない」ということにあると思います。また、エンティティについてのよくある誤解としては、「とりあえずIDを持ったオブジェクトを定義すればいいんでしょ。」といったものです。同一性を理解し、誤解をなくせば、エンティティのことが分かりやすくなるのではないでしょうか。

## 同一性って何？
　あるドメインにおいて、同一性と呼ばれる性質を持つモノが存在し、これが業務において重要な知識である場合がよくあります。この知識をソフトウェアとして実現するさいに、よくある実装上の問題を解決する方法をまとめたものがエンティティと呼ばれるノウハウです。まずは業務の中から同一性を識別し、同一性を持つオブジェクト(エンティティオブジェクト)を定義することがモデリングの第一歩になります。

　同一性をいくつかの辞書で調べてみると、おおよそ次のように定義しています。
* 異なるもの同士がその性質から区別されない
* 時間や場所が変わったとしても同じものとして識別される

　 "異なるもの同士がその性質から区別されない"とは、ざっくり言えば「見た目や内容が共通する異なるものは存在するので、こういった特徴からは区別されない。」ということです。例えば「受付け窓口の呼出し掲示板」を想像してみて下さい。窓口担当者は、顧客対応の準備ができしだい、掲示板を使って待合室の顧客を呼び出すとします。顧客は名前を持ちますが、同じ名前は存在し得るので、名前によって呼び出す顧客を指定することはできません。顧客を呼び出すには、名前以外の何かによって顧客を指定できる(同じ名前の顧客を別人であると区別できる)必要があります。この顧客ような同一性を持つオブジェクトは、本来備わっている属性以外によって、"異なる"ということを判断できる必要があります。

<img src="/img/edu/ddd-entity-id1.png" width="300">
<br>

　"時間や場所が変わったとしても同じものとして識別される"とは、ざっくり言えば「あるモノは、時間がたっても、たとえ形が変わったとしても、同じのモノである。」ということです。例えば、「アルバム」を想像してみて下さい。アルバムには、幼少期の豆君の写真や、青年期の豆君の写真が載っています。豆君は時間を経て、容姿や性格が変化しますがどちらも同一人物です。その他の例として、「ペンネームによる書籍検索」を想像してみて下さい。本の著者はペンネームを持ち、このペンネームは変更されることがあります。書籍検索を行なうさいに、現在のペンネームで検索したとしても、過去のペンネームの著書も含めて取得"できるようにしたいのであれば"、このシステムでは異なるペンネームの著者を同一人物として識別できる必要があります。この著者ような同一性を持つオブジェクトは、ライフサイクルのなかで形態や内容が変わったとしても、同じであるということを識別できる必要があります。

<img src="/img/edu/ddd-entity-id2.png" width="400">
<br>

　このような同一性と呼ばれる性質を持つモノは業務によくあらわれますが、これを取り違えてしまうと、正しく業務を実現できません(※2)。つまり、別のモノを同じモノとして扱ってしまったり、同じモノを別のモノとして扱ってしまいます。例えば、ホテルを予約したさいに名前だけで予約を管理していたら、誤って同じ名前の別人を部屋に案内してしまうかもしれません。こういったことを避けるための一般的な解決策としては、予約システム内で一意となるような予約番号が予約ごとに採番されます。

同一性という性質はあるオブジェクトに本来備わっているわけではなく、あくまでその業務において必要かどうかによって、その性質の有無が決まります。したがって、ドメインモデルを作成するさいには、「同一性という観点で業務を注意深く分析し、同一性を正しく表現することを責務として持つエンティティオブジェクトを導出する。」ということが重要となります。

## どのように実現すべきか？
　エンティティオブジェクトを導出できたら、次にその振舞いについて考えてみましょう。

　同一性による区別を実現するためには、エンティティオブジェクトに対して一意となるような操作を定義します。つまり、「だれ？」と聞くと、他とは重複しない返事が返ってくるのであれば、それぞれのエンティティオブジェクトを取り違えず区別できます。

　注意して頂きたいのは、この「他と区別すること」を実現することだけが、エンティティと呼ばれるノウハウではないということです。エンティティは、同一性に関する知識をソフトウェアとして表現するという状況で頻繁に直面する問題に対して、解決策となるような構造を定義するためのノウハウです。「他と区別すること」を実現するだけでは、複雑さやドメイン知識の表現に関する問題を解決できず、ドメインモデルをうまく表現できません。

　「他と区別すること」というのは業務において多くの場合、重要な位置付けにあり、さらに、これをソフトウェアとして表現しようとすると複雑になりがちです。例えば、「これ」の内容を変更したり、「これ」と「それ」を比較するというような、モノを特定したり区別するという行為が、業務の中心となることが多いのではないでしょうか。また、ソフトウェアとして表現するさいには、属性の組み合わせがシステム内で一意になるのか、識別子を生成する場合どのように一意であることを保証するのか、複数のシステムで有効な識別子を扱いたい場合はどのようにするのか等、考えることはたくさんあります。

　同一性の実現だけでも複雑になりがちなエンティティオブジェクトが、同一性以外も実現しようとすると、そのオブジェクトにとって何が最も重要なのかが霞んでしまいます。同一性だけに集中したくても、どの操作が同一性に関連するものなのか不明瞭になってしまいます。ドメイン知識を強調して上手く表現することは、ドメインモデルにおける重要な役割のひとつですが、このままでは上手く表現できません。

　こういったことから、エンティティオブジェクトを定義するさいに、同一性を強調して表現しつつ、簡便な構造とするために、下記の属性のみを残すようにします。下記の属性以外については、なるべく関連した他のオブジェクト(他のエンティティや値オブジェクト)に移動できないか検討します。
* 同一性に関連する属性
* 検索に用いられる属性
* 本質的な振舞いとこれに関連する属性

<img src="/img/edu/ddd-entity-impl.png" width="800">
<br>

　このエンティティオブジェクトの定義について、社員管理システムを例に挙げて説明します。このシステムでは、社員を特定し、その社員情報を取得・更新できるとします。また、職階単位で社員情報の一覧を取得したり、指定した文字列に一致する名前を持つ社員の情報を取得できるとします。この社員情報は、社員番号と、職階、名前、住所、家族構成等によって構成されています。社員を区別する必要があることから、社員は同一性を持ち、その同一性による区別を実現するために社員番号を用います。このようなシステムの社員オブジェクトは、個人を特定できるということが最も重要であることから、社員番号と検索に用いられる職階や名前のみを残して、それ以外を別のオブジェクト(個人情報オブジェクト、業務スキル)に分離すべきでしょう。こうすることによって、何によって特定されるのか、どういったまとまりで閲覧される場合があるのかといった知識を強調して表現できます。また、個人情報の変更、個人情報から書類提出の必要性の判断、業務スキルから特定の業務に携わることの可否の判断等の振舞いを、同一性に関するまとまりから分離できます。

<img src="/img/edu/ddd-entity-class.png" width="700">

## まとめ
　エンティティをざっくりと説明してきました。まとめると、ドメインモデルを定義するさいには、まず、以下のような性質を持ったモノがないか業務を注意深く分析することが重要となります。
* 異なるもの同士がその性質から区別されない
* 時間や場所が変わったとしても同じものとして識別される

　このような性質(同一性)持つオブジェクトを定義できたら、次に、以下のような属性のみを残して、その他については別のオブジェクトに移動できないか検討します。
* 同一性に関連する属性
* 検索に用いられる属性
* 本質的な振舞いとこれに関連する属性

このエンティティと呼ばれるノウハウに従うことによって、業務として重要な知識を見つけ出し、それを強調した簡素な構造としてドメインモデルを表現可能となります。

　本記事によって、エンティティとは何なのか、ドメインモデルを表現する上で、なぜ重要なのかをなんとなくでも理解して頂ければと思います。豆蔵教育では、よりDDDの全体的な内容を解説し、演習を通してリアリティを持って理解できるような研修を提供しています。豆蔵教育に少しでも関心を持って頂ければと思います。また、この記事で説明していることがエンティティのすべてではありません。エヴァンス本[1]や、その他の書籍[2]では、同一性を管理する上で注意するべきことや、実装方法について等、詳しく説明されています。本記事について理解したことが、これらの書籍の内容を理解するための助けになれば、幸いです。


※1. 本記事は、あえてパターンという技術用語を使わずに説明しています。ソフトウェアパターン[3]というのは、DDDを理解するためだけでなく、エンジニアとして理解すべき技術のひとつなので、ぜひ、関連書籍を参照してみて下さい。
※2. エヴァンス本では、「同一性を取り違えるとデータの破損につながりかねない」と説明しています。
[1] Evans, E., Domain-Driven Design: Tackling Complexity in the Heart of Software, Addison-Wesley Professional, 2003.
[2] Vernon, V., Implementing Domain-Driven Design, Addison-Wesley Professional, 2013.
[3] Buschmann, F., Meunier, R., Rohnert, H., Sommerlad, P. and Stal, M., Pattern-Oriented Software Architecture: A System of Patterns, John Wiley & Sons, 1996.
